$services_from_registry = Get-ItemProperty -Path HKLM:\System\CurrentControlSet\Services\*

#$services_from_registry | where { ($_.ObjectName -match 'LocalSystem') }

$localsystem_service = $services_from_registry | where { ($_.ObjectName -match 'LocalSystem') }

function Write-ServiceNames {
    Write-Output "" "    Service Names" "   ---------------"
    $localsystem_service | Select-Object PSChildName
}

function Write-ServicesImagePath {
    Write-Output "" "    Services and Their ImagePath" "   ------------------------------"
    #$localsystem_service | Where-Object { ($_.ObjectName -match 'LocalSystem') } | Select-Object PSChildName,ImagePath | Where-Object { ($_.ImagePath -notcontains 'svchost.exe') }
    $localsystem_service | Where-Object { ($_.ObjectName -match 'LocalSystem') } | Where-Object { ($_.ImagePath -notlike '*svchost.exe*') } | Select-Object PSChildName,ImagePath
}

function Write-ServicesImagePathPerms {
    Write-Output "" "    Services and Their ImagePath perms" "   ------------------------------"
    $perms = $localsystem_service | Where-Object { ($_.ObjectName -match 'LocalSystem') } | Where-Object { ($_.ImagePath -notlike '*svchost.exe*') } | Select-Object -ExpandProperty ImagePath
    $perms
    # foreach ($index in $perms) {
    #     Write-Output $index
    #     cmd /c "icacls.exe " $index
    # }
}

Write-ServicesImagePath
# Write-ServicesImagePathPerms
